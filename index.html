<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TheraSpace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* Fullscreen Fix */
    html, body { height: 100%; width: 100%; background-color: #050511; color: white; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; overflow: hidden; }
    #root { height: 100dvh; width: 100%; display: flex; flex-direction: column; }
    
    .no-scroll::-webkit-scrollbar { display: none; }
    .no-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    
    .glass { background: rgba(30, 30, 50, 0.4); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
    .glass-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
    .neon-text { text-shadow: 0 0 10px rgba(167, 139, 250, 0.5); }
    .icon-glow { filter: drop-shadow(0 0 5px rgba(167, 139, 250, 0.6)); }
    
    @keyframes fade { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } } .anim-fade { animation: fade 0.4s ease-out; }
    @keyframes slide { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .anim-slide { animation: slide 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
    @keyframes breathe {
      0% { transform: scale(1); opacity: 0.6; box-shadow: 0 0 20px rgba(45,212,191,0.2); }
      40% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 80px rgba(45,212,191,0.6); } 
      60% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 80px rgba(45,212,191,0.6); } 
      100% { transform: scale(1); opacity: 0.6; box-shadow: 0 0 20px rgba(45,212,191,0.2); } 
    }
    .anim-breathe { animation: breathe 12s infinite ease-in-out; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    /* --- 1. ICONES SVG (Mises √† jour) --- */
    const SVG = {
      Logo: "M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z",
      Home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",
      Echo: "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z",
      Journal: "M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z",
      Hero: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
      Oracle: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10z M12 10a2 2 0 1 1 0 4 2 2 0 0 1 0-4z",
      
      // ICONS MISES √Ä JOUR
      // Identit√© (Silhouette/User)
      Identity: "M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z", 
      // Respiration (Souffle)
      Breath: "M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2",
      
      X: "M18 6L6 18M6 6l12 12",
      Check: "M20 6L9 17l-5-5",
      ArrowLeft: "M19 12H5M12 19l-7-7 7-7",
      ArrowRight: "M5 12h14M12 5l7 7-7 7",
      AlertTriangle: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01",
      Phone: "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",
      Activity: "M22 12h-4l-3 9L9 3l-3 9H2",
      Lock: "M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a7 7 0 00-14 0v2",
      Play: "M5 3l14 9-14 9V3z",
      Plus: "M12 5v14M5 12h14",
      Clock: "M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20zM12 6v6l4 2",
      Share2: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
      SkipForward: "M5 4l10 8-10 8V4zM19 5v14",
      Sparkles: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
      Zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
      Crown: "M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14",
      MessageCircle: "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7",
      Moon: "M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z",
      Sun: "M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2",
      Heart: "M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z",
      Fingerprint: "M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 6",
      Swipe: "M17 11l-5-5-5 5 M17 18l-5-5-5 5"
    };

    const Icon = ({ name, size = 24, className }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} icon-glow`}>
        <path d={SVG[name] || ""} />
      </svg>
    );

    /* --- 2. CLIENT API --- */
    const callAPI = async (mode, data={}, context={}) => {
      try {
        const res = await fetch('/api/chat', { 
          method: 'POST', 
          headers: {'Content-Type':'application/json'}, 
          body: JSON.stringify({mode, data, context}) 
        });
        if(!res.ok) throw new Error();
        return await res.json();
      } catch (e) {
        // Fallbacks pour test imm√©diat
        if(mode==='GENERATE_SCENARIOS') return Array.from({length:20}, (_,i) => ({id:i, text:`Situation ${i+1} : Tu r√©ussis un truc difficile.`, type: i%2===0?'pos':'neg'}));
        if(mode==='GENERATE_ORACLE') return {title:"Le Sage", story:"Respire le calme, expire la peur.", moral:"Patience."};
        if(mode==='ANALYZE_HERO') return {
            archetype:"Le B√¢tisseur", 
            analysis:"Tu construis ta vie pierre par pierre.", 
            roadmap: Array.from({length:8}, (_,i)=>({week:i+1, focus:`Semaine ${i+1}`, tasks:["T√¢che 1", "T√¢che 2", "T√¢che 3"]}))
        };
        if(mode==='SYNTHESIZE_IDENTITY') return {text: "Tu es une personne riche et complexe."};
        return null;
      }
    };

    /* --- 3. DATA & QUESTIONS --- */
    const EMOTIONS = [
      { id: 'colere', emoji: 'üò°', label: 'Rage' }, { id: 'peur', emoji: 'üò∞', label: 'Stress' },
      { id: 'tristesse', emoji: 'üò¢', label: 'Tristesse' }, { id: 'honte', emoji: 'üò≥', label: 'Honte' },
      { id: 'vide', emoji: 'üò∂', label: 'Vide' }, { id: 'calme', emoji: 'üòå', label: 'Calme' },
      { id: 'joie', emoji: 'ü§©', label: 'Joie' }, { id: 'confiance', emoji: 'ü¶Å', label: 'Fiert√©' },
    ];
    const STRATEGIES = [
      { id: 'parler', label: "J'en parle", icon:"MessageCircle" }, { id: 'musique', label: "Musique", icon:"Play" },
      { id: 'isolement', label: "Je m'isole", icon:"Moon" }, { id: 'sport', label: "Je bouge", icon:"Activity" },
      { id: 'scroll', label: "√âcrans", icon:"Fingerprint" }, { id: 'art', label: "Cr√©ation", icon:"Sparkles" },
      { id: 'gratitude', label: "Gratitude", icon:"Heart" }, { id: 'savourer', label: "Je savoure", icon:"Sun" },
    ];
    
    // Identit√© (Corrig√©)
    const IDENTITY_QS = [
        {id:'surnom', l:"Quel est ton surnom ?"},
        {id:'qualite', l:"Ton super-pouvoir (Qualit√©)"},
        {id:'defaut', l:"Ta kryptonite (Point faible)"},
        {id:'plat', l:"Ton plat r√©confort"},
        {id:'film', l:"Ta s√©rie ou film culte"},
        {id:'best_mem', l:"Ton meilleur souvenir"},
        {id:'worst_mem', l:"Ton pire souvenir"},
        {id:'bff', l:"Ton/Ta confident(e)"},
        {id:'anecdote', l:"Une anecdote sur toi"},
        {id:'event', l:"L'√©v√©nement qui t'a marqu√©"},
        {id:'activite', l:"Ce que tu kiffes faire"},
        {id:'totem', l:"Ton animal totem"},
        {id:'son', l:"La B.O. de ta vie"},
        {id:'refuge', l:"Ton endroit safe"},
        {id:'saison', l:"Ta saison pr√©f√©r√©e"},
        {id:'peur', l:"Ta plus grande peur"},
        {id:'idole', l:"La personne que tu admires"}
    ];

    const HERO_QUIZ = [
      { cat: 'competence', q: "Je finis ce que je commence." }, { cat: 'competence', q: "Je sais r√©soudre mes gal√®res." }, { cat: 'competence', q: "J'ai des talents dont je suis fier(e)." }, { cat: 'competence', q: "Je r√©ussis aussi bien que les autres." }, { cat: 'competence', q: "Je me sens utile au quotidien." },
      { cat: 'knowledge', q: "Je sais dire ce que je ressens." }, { cat: 'knowledge', q: "Je connais mes points forts." }, { cat: 'knowledge', q: "J'ai mes propres opinions." },
      { cat: 'security', q: "Je me sens bien dans ma peau." }, { cat: 'security', q: "L'avenir ne me fait pas trop peur." }, { cat: 'security', q: "J'accepte mon corps." },
      { cat: 'belonging', q: "Je me sens aim√©(e) par mes proches." }, { cat: 'belonging', q: "J'ai ma place dans un groupe." }, { cat: 'belonging', q: "Je peux compter sur quelqu'un." }
    ];

    /* --- 4. COMPOSANTS UI --- */
    const Glass = ({ children, onClick, className="" }) => <div onClick={onClick} className={`glass rounded-[24px] overflow-hidden ${className}`}>{children}</div>;
    const Btn = ({ onClick, children, variant='primary', disabled, className="" }) => {
      const s = { primary: "bg-gradient-to-r from-violet-600 to-indigo-600 shadow-lg text-white", secondary: "bg-white/5 border border-white/10 text-white", accent: "bg-gradient-to-r from-emerald-500 to-teal-500 text-white", gold: "bg-gradient-to-r from-amber-400 to-orange-500 text-white" };
      return <button onClick={onClick} disabled={disabled} className={`px-5 py-4 rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 ${s[variant]} ${className}`}>{children}</button>;
    };

    /* --- 5. MODULES --- */
    const SOS = ({ close }) => (
      <div className="fixed inset-0 z-50 bg-slate-900/95 flex items-center justify-center p-6 anim-fade">
        <div className="w-full max-w-sm glass border-red-500/30 p-6 text-center shadow-2xl">
          <div className="w-24 h-24 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 anim-pulse"><Icon name="AlertTriangle" size={48}/></div>
          <h2 className="text-3xl font-black text-white mb-6">Besoin d'aide ?</h2>
          <div className="space-y-3">
            <a href="tel:3114" className="block w-full bg-red-600 text-white font-bold py-4 rounded-xl flex justify-center gap-3 shadow-lg"><Icon name="Phone"/> 31 14 (√âcoute)</a>
            <a href="tel:15" className="block w-full bg-white text-slate-900 font-bold py-4 rounded-xl flex justify-center gap-2 shadow-lg"><Icon name="Activity"/> 15 (Urgence)</a>
          </div>
          <button onClick={close} className="mt-10 text-slate-500 font-bold text-sm tracking-widest uppercase">RETOUR</button>
        </div>
      </div>
    );

    const Auth = ({ login }) => {
      const [e, setE] = useState(''); const [p, setP] = useState('');
      return <div className="h-full flex flex-col items-center justify-center p-8 anim-fade">
        <div className="w-24 h-24 rounded-full bg-gradient-to-tr from-violet-600 to-indigo-600 flex items-center justify-center shadow-lg mb-8 border-4 border-[#0f0b1e] icon-box"><Icon name="Logo" size={48} className="text-white"/></div>
        <h1 className="text-4xl font-black text-white mb-2 neon-text">TheraSpace</h1>
        <p className="text-slate-400 mb-10 text-lg">Ton refuge num√©rique.</p>
        <div className="w-full space-y-4">
            <Glass className="p-4 flex gap-3 items-center"><Icon name="Identity" className="text-slate-500"/><input placeholder="Pseudo" value={e} onChange={x=>setE(x.target.value)} className="bg-transparent w-full outline-none text-white font-medium"/></Glass>
            <Glass className="p-4 flex gap-3 items-center"><Icon name="Lock" className="text-slate-500"/><input type="password" placeholder="Mot de passe" value={p} onChange={x=>setP(x.target.value)} className="bg-transparent w-full outline-none text-white font-medium"/></Glass>
            <Btn onClick={()=>login({name:e})} disabled={!e||!p} className="w-full mt-4">Entrer</Btn>
        </div>
      </div>;
    };

    const Dashboard = ({ nav, user }) => {
      const [sos, setSos] = useState(false);
      return <div className="h-full overflow-y-auto no-scroll p-6 pt-10 pb-32 space-y-6 anim-fade">
        {sos && <SOS close={()=>setSos(false)}/>}
        <header className="flex justify-between items-center mb-4"><div><h1 className="text-3xl font-black">Salut {user.name}</h1><p className="text-indigo-300 text-sm font-medium">Espace S√©curis√©</p></div><div className="flex gap-3"><button onClick={()=>setSos(true)} className="w-12 h-12 rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-500 anim-pulse"><Icon name="AlertTriangle"/></button></div></header>
        
        <div onClick={()=>nav('echo')} className="active:scale-95 transition-transform"><Glass className="p-8 flex justify-between items-center relative overflow-hidden h-40"><div className="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 opacity-40"/><div><h3 className="text-3xl font-black mb-2">√âCHO</h3><p className="text-slate-300 text-sm">Exploration guid√©e</p></div><div className="w-20 h-20 rounded-full bg-white/10 flex items-center justify-center border border-white/20"><Icon name="Echo" size={40}/></div></Glass></div>
        
        <div className="grid grid-cols-2 gap-4">
            <Glass className="p-6 h-32 flex flex-col justify-between active:scale-95" onClick={()=>nav('hero')}><Icon name="Hero" className="text-amber-400" size={32}/><h4 className="font-bold text-lg">H√©ros</h4></Glass>
            <Glass className="p-6 h-32 flex flex-col justify-between active:scale-95" onClick={()=>nav('journal')}><Icon name="Journal" className="text-emerald-400" size={32}/><h4 className="font-bold text-lg">Journal</h4></Glass>
        </div>
      </div>;
    };

    const Echo = ({ exit }) => {
        const [cards, setCards] = useState([]); const [idx, setIdx] = useState(0); const [step, setStep] = useState('load'); const [hist, setHist] = useState([]); const [curr, setCurr] = useState({emotions:[], strategies:[]}); const [aiRes, setAiRes] = useState(null);
        
        useEffect(() => { 
            const timer = setTimeout(() => { if(cards.length===0) setCards(Array.from({length:20},(_,i)=>({id:i, text:`Situation ${i+1} g√©n√©r√©e.`, type:"neu"}))); setStep('play'); }, 4000);
            callAPI('GENERATE_SCENARIOS').then(d => { clearTimeout(timer); setCards(d); setStep('play'); }); 
        }, []);

        const next = () => {
            const newHist = [...hist, {card:cards[idx], ...curr}];
            if(idx<cards.length-1) { setHist(newHist); setIdx(idx+1); setStep('scenario'); setCurr({emotions:[], strategies:[]}); }
            else { setStep('analyzing'); callAPI('ANALYZE_ECHO', newHist).then(res => { setAiRes(res); setStep('feedback'); }); }
        };
        const toggle = (l, i) => l.includes(i) ? l.filter(x=>x!==i) : [...l, i];

        if(step==='load') return <div className="h-full flex flex-col items-center justify-center text-center"><Icon name="Sparkles" className="animate-spin text-fuchsia-500 mb-4" size={48}/><p>Cr√©ation du monde (20 situations)...</p></div>;
        if(step==='analyzing') return <div className="h-full flex flex-col items-center justify-center text-center"><Icon name="Zap" className="animate-pulse text-indigo-500 mb-4" size={48}/><p>Analyse de ta session...</p></div>;
        if(step==='feedback') return <div className="h-full p-6 pt-10 anim-fade"><h2 className="text-2xl font-black mb-6 text-center">Bilan IA</h2><Glass className="p-6 mb-4"><h3 className="font-bold mb-2 text-lg text-emerald-400">Observation</h3><p>{aiRes?.observation}</p></Glass><Glass className="p-6 bg-gradient-to-br from-indigo-900 to-slate-900"><h3 className="font-bold mb-2 text-lg text-yellow-400">Conseil</h3><p className="italic">"{aiRes?.conseil}"</p></Glass><Btn onClick={exit} className="w-full mt-8" variant="secondary">Retour</Btn></div>;

        const card = cards[idx] || {text:"..."};
        return <div className="h-full flex flex-col p-6 pt-10 relative"><div className="flex justify-between items-center mb-6"><button onClick={exit}><Icon name="X" className="text-slate-400"/></button><span className="text-indigo-400 font-bold text-xs uppercase">Carte {idx+1}/{cards.length}</span><div className="w-6"/></div><div className="w-full h-1 bg-slate-800 rounded-full mb-6"><div className="h-full bg-fuchsia-500 transition-all" style={{width: `${((idx+1)/cards.length)*100}%`}}/></div><Glass className="flex-1 flex flex-col relative overflow-hidden">{step==='scenario' ? <div className="flex-1 flex flex-col justify-center items-center p-8 text-center anim-slide"><h2 className="text-2xl font-black leading-snug mb-12">"{card.text}"</h2><div className="grid grid-cols-2 gap-4 w-full mt-auto"><Btn variant="secondary" onClick={()=>next()}>Pas v√©cu</Btn><Btn variant="primary" onClick={()=>setStep('interaction')}>C'est v√©cu</Btn></div></div> : <div className="flex-1 flex flex-col p-6 overflow-y-auto anim-slide"><div className="space-y-6"><div><p className="text-slate-500 text-xs font-bold uppercase mb-2">√âmotions</p><div className="flex flex-wrap gap-2">{EMOTIONS.map(e=><button key={e.id} onClick={()=>setCurr({...curr, emotions:toggle(curr.emotions, e.id)})} className={`px-3 py-2 rounded-xl border text-sm font-bold flex gap-2 ${curr.emotions.includes(e.id)?'bg-fuchsia-600 border-fuchsia-500 shadow-lg':'bg-white/5 border-white/10 text-slate-400'}`}>{e.emoji} {e.label}</button>)}</div></div><div><p className="text-slate-500 text-xs font-bold uppercase mb-2">Strat√©gies</p><div className="grid grid-cols-2 gap-2">{STRATEGIES.map(s=><button key={s.label} onClick={()=>setCurr({...curr, strategies:toggle(curr.strategies, s.label)})} className={`p-3 rounded-xl border text-sm font-bold flex flex-col items-center gap-2 ${curr.strategies.includes(s.label)?'bg-indigo-600 border-indigo-500 shadow-lg':'bg-white/5 border-white/10 text-slate-400'}`}><Icon name={s.icon} size={18}/> {s.label}</button>)}</div></div></div><Btn onClick={next} disabled={curr.emotions.length===0} className="mt-8 w-full">Suivant</Btn></div>}</Glass></div>;
    };

    const Hero = ({ exit }) => {
        const [s, setS] = useState('intro'); const [q, setQ] = useState(0); const [sc, setSc] = useState({competence:0,knowledge:0,security:0,belonging:0}); const [res, setRes] = useState(null);
        const ans = (v) => { const cat = HERO_QUIZ[q].cat; setSc({...sc, [cat]: sc[cat]+v}); if(q<HERO_QUIZ.length-1) setQ(c=>c+1); else { setS('load'); callAPI('ANALYZE_HERO', sc).then(r=>{setRes(r); setS('res');}); } };
        if(s==='intro') return <div className="h-full p-8 flex flex-col items-center justify-center text-center anim-fade"><Icon name="Hero" size={64} className="text-amber-400 mb-6 icon-box"/><h2 className="text-3xl font-black mb-4">La Forge</h2><p className="text-slate-400 mb-8">Programme 60 jours pour booster ta confiance.</p><Btn onClick={()=>setS('quiz')} variant="gold">Commencer</Btn><button onClick={exit} className="mt-8 text-slate-500">Quitter</button></div>;
        if(s==='quiz') return <div c
