<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TheraSpace - √âdition Ultimate</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { background-color: #0f0b1e; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.5s ease-out; }
    @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slide-up { animation: slide-up 0.4s ease-out; }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .animate-pulse-slow { animation: pulse-slow 3s infinite; }
    @keyframes flip-in { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }
    .animate-flip-in { animation: flip-in 0.6s ease-out; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { 
      Home, Book, Activity, User, Play, X, Check, ArrowRight, ArrowLeft,
      Sparkles, Zap, Shield, Heart, MessageCircle, Moon, Sun, Cloud,
      Mic, Image as ImageIcon, Plus, Thermometer, Wind, Fingerprint, 
      Smile, Frown, Meh, Save, Trash2, Mail, Share2, Crown, Swords, Ghost,
      Flame, Anchor, Compass, Lock, Phone, AlertTriangle, SkipForward, Calendar, Clock
    } = lucide.icons;

    /* --- MOTEUR IA S√âCURIS√â (Appelle api/chat.js) --- */
    const callBackend = async (systemPrompt, userPrompt, jsonMode = false) => {
      try {
        // L'application appelle VOTRE serveur Vercel, pas Mistral direct
        const response = await fetch('/api/chat', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ systemPrompt, userPrompt, jsonMode })
        });
        
        if (!response.ok) throw new Error("Erreur serveur");
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error("Erreur IA:", error);
        return null; // D√©clenchera le mode hors ligne/d√©mo
      }
    };

    const LYA_AI = {
      analyzeHero: async (scores) => {
        const fallback = (() => {
            let archetype = "Guerrier";
            if (scores.knowledge > scores.competence) archetype = "Sage";
            else if (scores.belonging > scores.security) archetype = "Gardien";
            return { title: `${archetype} de Lumi√®re`, stats: scores, mission: "Note une victoire aujourd'hui." };
        })();
        
        const system = `Tu es Lya, psy TCC. Analyse les scores et renvoie un JSON { "title": "Nom Arch√©type", "mission": "Mission courte" }`;
        const user = `Scores: ${JSON.stringify(scores)}`;
        
        // On appelle le backend
        const res = await callBackend(system, user, true);
        
        try { return res ? JSON.parse(res) : fallback; } catch (e) { return fallback; }
      },
      
      generateOracle: async () => {
         const fallback = { title: "Le Ph√©nix", text: "Pour rena√Ætre, il faut accepter de br√ªler un peu." };
         const system = `Tu es l'Oracle. Donne une m√©taphore courte et sage. JSON: { "title": "Nom", "text": "Message" }`;
         const res = await callBackend(system, "Oracle", true);
         try { return res ? JSON.parse(res) : fallback; } catch (e) { return fallback; }
      },
      
      synthesizeIdentity: async (answers) => {
          const res = await callBackend("Fais une synth√®se 'Cold Reading' bienveillante en 2 phrases.", JSON.stringify(answers), false);
          return res || "Tu as une personnalit√© riche et unique.";
      },
      
      analyzeEcho: async (history) => {
          const fallback = { observation: "Tu as bien identifi√© tes √©motions.", conseil: "Continue." };
          const system = `Analyse cette session TCC. Il n'y a plus de th√®mes, d√©duis-les. JSON: { "observation": "...", "conseil": "..." }`;
          const res = await callBackend(system, JSON.stringify(history), true);
          try { return res ? JSON.parse(res) : fallback; } catch (e) { return fallback; }
      }
    };

    /* --- DATA --- */
    const REALISTIC_SCENARIOS = [
      { id: 1, text: "Tu ouvres Insta et tu tombes sur une story : tous tes potes sont ensemble sans toi.", type: 'neg' },
      { id: 2, text: "Le prof rend les contr√¥les. Tu caches ta feuille car tu as honte de ta note.", type: 'neg' },
      { id: 3, text: "Tes parents te reprochent encore d'√™tre 'tout le temps sur ton t√©l√©phone'.", type: 'neg' },
      { id: 4, text: "Tu as envoy√© un message risqu√© √† ton crush. 'Vu', pas de r√©ponse depuis 2h.", type: 'neg' },
      { id: 5, text: "Tu te regardes dans le miroir avant de sortir. Rien ne va, tu te trouves horrible.", type: 'neg' },
      { id: 6, text: "On t'interroge √† l'oral. Ta gorge se serre, aucun son ne sort.", type: 'neg' },
      { id: 20, text: "Tu as r√©ussi un truc difficile du premier coup. Personne n'a vu, mais tu es fier(e).", type: 'pos' },
      { id: 21, text: "Tu √©coutes ta playlist √† fond dans ta chambre. Tu te sens invincible.", type: 'pos' },
      { id: 22, text: "Quelqu'un te fait un compliment sinc√®re sur ton style aujourd'hui.", type: 'pos' },
      { id: 30, text: "Tu es seul(e) chez toi. Le silence est total.", type: 'neu' }
    ];
    const EMOTIONS = [
      { id: 'colere', emoji: 'üò°', label: 'Rage' }, { id: 'peur', emoji: 'üò∞', label: 'Stress' },
      { id: 'tristesse', emoji: 'üò¢', label: 'Tristesse' }, { id: 'honte', emoji: 'üò≥', label: 'Honte' },
      { id: 'vide', emoji: 'üò∂', label: 'Vide' }, { id: 'calme', emoji: 'üòå', label: 'Calme' },
      { id: 'joie', emoji: 'ü§©', label: 'Joie' }, { id: 'confiance', emoji: 'ü¶Å', label: 'Fiert√©' },
    ];
    const STRATEGIES = [
      { id: 'parler', icon: MessageCircle, label: "J'en parle" }, { id: 'musique', icon: Play, label: "Musique" },
      { id: 'isolement', icon: Moon, label: "Je m'isole" }, { id: 'sport', icon: Activity, label: "Je bouge" },
      { id: 'scroll', icon: Fingerprint, label: "√âcrans" }, { id: 'art', icon: Sparkles, label: "Cr√©ation" },
      { id: 'gratitude', icon: Heart, label: "Gratitude" }, { id: 'savourer', icon: Sun, label: "Je savoure" },
    ];
    const HERO_QUIZ = [
      { cat: 'competence', q: "Je finis ce que je commence." }, { cat: 'competence', q: "Je sais r√©soudre mes probl√®mes." }, { cat: 'competence', q: "J'ai des talents dont je suis fier(e)." }, { cat: 'competence', q: "Je r√©ussis aussi bien que les autres." }, { cat: 'competence', q: "Je me sens utile au quotidien." },
      { cat: 'knowledge', q: "Je sais dire ce que je ressens." }, { cat: 'knowledge', q: "Je connais mes points forts." }, { cat: 'knowledge', q: "J'ai mes propres opinions." },
      { cat: 'security', q: "Je me sens bien dans ma peau." }, { cat: 'security', q: "L'avenir ne me fait pas trop peur." }, { cat: 'security', q: "J'accepte mon corps tel qu'il est." },
      { cat: 'belonging', q: "Je me sens aim√©(e) par mes proches." }, { cat: 'belonging', q: "J'ai ma place dans un groupe." }, { cat: 'belonging', q: "Je peux compter sur quelqu'un." }
    ];
    const IDENTITY_SHORT_QUESTIONS = [
      { id: 'surnom', label: "Mon Surnom" }, { id: 'totem', label: "Animal Totem" }, { id: 'force', label: "Ma Force" }, { id: 'krypto', label: "Ma Faiblesse" },
      { id: 'hobby', label: "Passion n¬∞1" }, { id: 'song', label: "Chanson Hype" }, { id: 'color', label: "Couleur" }, { id: 'place', label: "Refuge" },
      { id: 'season', label: "Saison" }, { id: 'dream', label: "R√™ve fou" }, { id: 'fear', label: "Peur" }, { id: 'hero', label: "Idole" },
      { id: 'food', label: "Plat confort" }, { id: 'word', label: "Mot pr√©f√©r√©" }, { id: 'mood', label: "Vibe actuelle" }
    ];

    /* --- UI --- */
    const GlassPanel = ({ children, className = '', onClick }) => (<div onClick={onClick} className={`backdrop-blur-xl bg-[#1e1b4b]/70 border border-white/10 shadow-2xl rounded-[32px] overflow-hidden ${className}`}>{children}</div>);
    const ActionButton = ({ onClick, children, variant = 'primary', className = '', disabled }) => {
      const s = { primary: "bg-gradient-to-r from-violet-600 to-indigo-600 shadow-indigo-500/30", secondary: "bg-white/5 border-white/10", accent: "bg-gradient-to-r from-emerald-500 to-teal-500", gold: "bg-gradient-to-r from-amber-400 to-orange-500" };
      return <button onClick={onClick} disabled={disabled} className={`px-6 py-4 rounded-2xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 text-white shadow-lg ${s[variant]} ${className}`}>{children}</button>;
    };
    const NavIcon = ({ Icon, active, onClick }) => (<button onClick={onClick} className={`p-2 transition-colors ${active ? 'text-white' : 'text-slate-500 hover:text-slate-300'}`}><Icon size={24} /></button>);

    /* --- MODULES --- */
    const SOSModal = ({ onClose }) => (
        <div className="absolute inset-0 z-[100] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in"><div className="w-full max-w-sm bg-[#1e1b4b] border border-red-500/30 rounded-[32px] p-6 text-center shadow-[0_0_50px_rgba(220,38,38,0.3)]"><div className="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 animate-pulse"><AlertTriangle size={40}/></div><h2 className="text-3xl font-black text-white mb-2">Besoin d'aide ?</h2><div className="space-y-4"><a href="tel:3114" className="block w-full bg-red-600 text-white font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-3"><Phone size={24}/> 31 14 (√âcoute)</a><a href="tel:15" className="block w-full bg-white text-slate-900 font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-3"><Activity size={24}/> 15 (Urgence)</a></div><button onClick={onClose} className="mt-8 text-slate-500 font-bold text-sm uppercase tracking-widest">Retour</button></div></div>
    );

    const AuthScreen = ({ onLogin }) => {
        const [email, setEmail] = useState(''); const [pin, setPin] = useState('');
        return (
            <div className="h-full flex flex-col items-center justify-center p-8 animate-fade-in"><div className="w-24 h-24 rounded-full bg-gradient-to-tr from-violet-600 to-indigo-600 flex items-center justify-center shadow-[0_0_50px_rgba(139,92,246,0.5)] mb-8 border-4 border-[#0f0b1e]"><Fingerprint size={40} className="text-white"/></div><h1 className="text-3xl font-black text-white mb-2">TheraSpace</h1><p className="text-slate-400 mb-10">Ton refuge num√©rique.</p><div className="w-full space-y-4"><GlassPanel className="p-4 flex items-center gap-3"><Mail className="text-slate-500" size={20}/><input type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="bg-transparent text-white w-full focus:outline-none"/></GlassPanel><GlassPanel className="p-4 flex items-center gap-3"><Lock className="text-slate-500" size={20}/><input type="password" placeholder="Code (ex: 0000)" value={pin} onChange={e=>setPin(e.target.value)} className="bg-transparent text-white w-full focus:outline-none font-bold tracking-widest"/></GlassPanel><ActionButton onClick={() => onLogin({ name: email.split('@')[0] || 'Voyageur' })} disabled={!email || pin.length < 4} className="w-full mt-4">Entrer <ArrowRight/></ActionButton></div></div>
        );
    };

    const Dashboard = ({ onNavigate, user }) => {
        const [showSOS, setShowSOS] = useState(false);
        return (
            <div className="h-full overflow-y-auto scrollbar-hide p-6 pt-10 pb-32 space-y-8 animate-fade-in relative">
                {showSOS && <SOSModal onClose={() => setShowSOS(false)} />}
                <header className="flex justify-between items-center"><div><h1 className="text-3xl font-black text-white tracking-tight mb-1">Salut {user.name}</h1><p className="text-indigo-300 text-sm">Espace S√©curis√©</p></div><div className="flex gap-3"><button onClick={()=>setShowSOS(true)} className="w-12 h-12 rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-500 animate-pulse"><AlertTriangle size={24}/></button><button onClick={()=>onNavigate('profile')} className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-400"><User size={24}/></button></div></header>
                <div onClick={()=>onNavigate('echo')} className="relative group cursor-pointer active:scale-95 transition-transform"><div className="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-[32px] blur opacity-60"/><GlassPanel className="relative p-8 flex items-center justify-between"><div><div className="flex items-center gap-2 mb-2"><span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"/><span className="text-xs font-bold text-indigo-200 uppercase tracking-wider">Lya Active</span></div><h3 className="text-3xl font-black text-white mb-2">√âCHO</h3><p className="text-slate-300 text-sm">Exploration guid√©e</p></div><div className="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-white"><Play size={24}/></div></GlassPanel></div>
                <div className="grid grid-cols-2 gap-4"><GlassPanel className="p-6 active:scale-95 transition-transform" onClick={()=>onNavigate('journal')}><Book className="text-emerald-400 mb-4" size={28}/><h4 className="font-bold text-white">Journal</h4></GlassPanel><GlassPanel className="p-6 active:scale-95 transition-transform" onClick={()=>onNavigate('hero')}><Shield className="text-amber-400 mb-4" size={28}/><h4 className="font-bold text-white">H√©ros</h4></GlassPanel></div>
            </div>
        );
    };

    const EchoGame = ({ onExit, onFinish }) => {
        const [cards, setCards] = useState(REALISTIC_SCENARIOS.sort(()=>0.5-Math.random()).slice(0,10));
        const [index, setIndex] = useState(0);
        const [step, setStep] = useState('scenario');
        const [history, setHistory] = useState([]);
        const [current, setCurrent] = useState({vecu:false, emotions:[], strategies:[]});
        const card = cards[index];
        const handleNext = () => { const newHistory = [...history, {card, ...current}]; if (index < cards.length - 1) { setHistory(newHistory); setIndex(i=>i+1); setStep('scenario'); setCurrent({vecu:false, emotions:[], strategies:[]}); } else onFinish(newHistory); };
        const toggle = (list, item) => list.includes(item) ? list.filter(i=>i!==item) : [...list, item];
        return <div className="h-full flex flex-col p-6 pt-10 relative"><div className="flex justify-between items-center mb-6"><button onClick={onExit}><X className="text-slate-400"/></button><span className="text-indigo-400 font-bold text-xs uppercase">Carte {index+1}/{cards.length}</span><div className="w-6"/></div><div className="w-full h-1 bg-slate-800 rounded-full mb-6"><div className="h-full bg-fuchsia-500 transition-all" style={{width: `${((index+1)/cards.length)*100}%`}}/></div><GlassPanel className="flex-1 flex flex-col relative overflow-hidden">{step==='scenario' ? (<div className="flex-1 flex flex-col justify-center items-center p-8 text-center animate-slide-up"><h2 className="text-2xl font-black text-white leading-snug mb-12">"{card.text}"</h2><div className="grid grid-cols-2 gap-4 w-full mt-auto"><ActionButton variant="secondary" onClick={()=>{setCurrent({...current, vecu:false}); handleNext()}}>Pas v√©cu</ActionButton><ActionButton variant="primary" onClick={()=>{setCurrent({...current, vecu:true}); setStep('interaction')}}>C'est v√©cu</ActionButton></div></div>) : (<div className="flex-1 flex flex-col p-6 overflow-y-auto animate-slide-up"><button onClick={()=>setStep('scenario')} className="text-slate-400 mb-4 flex gap-2 items-center"><ArrowLeft size={16}/> Retour</button><div className="space-y-6"><div><p className="text-slate-500 text-xs font-bold uppercase mb-2">√âmotions</p><div className="flex flex-wrap gap-2">{EMOTIONS.map(e=><button key={e.id} onClick={()=>setCurrent({...current, emotions:toggle(current.emotions, e.id)})} className={`px-3 py-2 rounded-xl border text-sm font-bold flex gap-2 ${current.emotions.includes(e.id)?'bg-fuchsia-500 border-fuchsia-400':'bg-white/5 border-white/10 text-slate-400'}`}>{e.emoji} {e.label}</button>)}</div></div><div><p className="text-slate-500 text-xs font-bold uppercase mb-2">R√©action</p><div className="grid grid-cols-2 gap-2">{STRATEGIES.map(s=>{ const Icon = s.icon; return (<button key={s.id} onClick={()=>setCurrent({...current, strategies:toggle(current.strategies, s.id)})} className={`p-3 rounded-xl border text-sm font-bold flex flex-col items-center gap-2 ${current.strategies.includes(s.id)?'bg-indigo-600 border-indigo-500':'bg-white/5 border-white/10 text-slate-400'}`}><Icon size={18}/> {s.label}</button>)})}</div></div></div><ActionButton onClick={handleNext} disabled={current.emotions.length===0} className="mt-8 w-full">Suivant</ActionButton></div>)}</GlassPanel></div>;
    };

    const HeroModule = ({ onExit }) => {
        const [step, setStep] = useState('intro'); const [currentQ, setCurrentQ] = useState(0); const [scores, setScores] = useState({competence:0, knowledge:0, security:0, belonging:0}); const [aiResult, setAiResult] = useState(null);
        const handleAnswer = (val) => { const cat = HERO_QUIZ[currentQ].cat; const newScores = {...scores, [cat]: scores[cat] + val}; setScores(newScores); if(currentQ < HERO_QUIZ.length-1) setCurrentQ(c=>c+1); else { setStep('loading'); LYA_AI.analyzeHero(newScores).then(res => { setAiResult(res); setStep('result'); }); } };
        if(step==='intro') return <div className="h-full p-8 flex flex-col items-center justify-center text-center animate-fade-in"><Crown size={64} className="text-amber-400 mb-6"/><h2 className="text-3xl font-black mb-4">Forge des H√©ros</h2><p className="text-slate-400 mb-8">D√©couvre tes forces cach√©es.</p><ActionButton onClick={()=>setStep('quiz')} variant="gold">Commencer</ActionButton><button onClick={onExit} className="mt-8 text-slate-500">Quitter</button></div>;
        if(step==='quiz') return <div className="h-full p-8 flex flex-col justify-center animate-slide-up"><h3 className="text-xl font-bold mb-8 text-center">"{HERO_QUIZ[currentQ].q}"</h3><div className="grid gap-3"><ActionButton onClick={()=>handleAnswer(3)} variant="secondary">Tout √† fait</ActionButton><ActionButton onClick={()=>handleAnswer(2)} variant="secondary">Plut√¥t oui</ActionButton><ActionButton onClick={()=>handleAnswer(1)} variant="secondary">Plut√¥t non</ActionButton><ActionButton onClick={()=>handleAnswer(0)} variant="secondary">Pas du tout</ActionButton></div></div>;
        if(step==='loading') return <div className="h-full flex items-center justify-center"><Sparkles className="animate-spin text-amber-400" size={48}/></div>;
        return <div className="h-full p-6 pt-10 flex flex-col items-center animate-fade-in"><h2 className="text-2xl font-black text-white mb-6">Ton Avatar</h2><div className="w-full max-w-sm bg-gradient-to-br from-amber-500 to-orange-700 p-1 rounded-3xl shadow-2xl animate-slide-up"><div className="bg-slate-900 rounded-[20px] p-6 flex flex-col items-center text-center"><Crown className="text-amber-400 mb-4" size={40"/><h3 className="text-2xl font-black italic text-white mb-6">{aiResult.title}</h3><div className="w-full space-y-4">
