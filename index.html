<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TheraSpace</title>
  
  <!-- 1. TAILWIND (Design) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. REACT (Moteur) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- 3. BABEL (Traducteur) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 4. LUCIDE ICONS (CORRECTIF CRITIQUE: Version React UMD) -->
  <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>

  <style>
    body { background-color: #0f0b1e; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; font-family: sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .animate-fade-in { animation: fade-in 0.5s ease-out; }
    @keyframes slide-up { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .animate-slide-up { animation: slide-up 0.4s ease-out; }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .animate-pulse-slow { animation: pulse-slow 3s infinite; }
    @keyframes flip-in { from { transform: rotateY(90deg); opacity: 0; } to { transform: rotateY(0); opacity: 1; } }
    .animate-flip-in { animation: flip-in 0.6s ease-out; }
    
    /* Style pour l'√©cran de chargement/erreur */
    #root:empty::before {
      content: "Chargement de TheraSpace...";
      display: flex;
      height: 100vh;
      justify-content: center;
      align-items: center;
      color: #6366f1;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Zone d'affichage des erreurs pour le d√©bogage -->
  <div id="error-display" style="display:none; color: #ff4444; padding: 20px; background: rgba(0,0,0,0.9); position: fixed; top: 0; left: 0; right: 0; z-index: 9999;"></div>
  
  <div id="root"></div>

  <script>
    // Script de s√©curit√© pour afficher les erreurs si l'√©cran reste bleu
    window.onerror = function(message, source, lineno, colno, error) {
      document.getElementById('error-display').style.display = 'block';
      document.getElementById('error-display').innerHTML = "<h3>Oups ! Une erreur est survenue :</h3><p>" + message + "</p><p>Ligne : " + lineno + "</p>";
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // --- CORRECTIF ICONS ---
    // On r√©cup√®re les ic√¥nes depuis l'objet global lucideReact
    const { 
      Home, Book, Activity, User, Play, X, Check, ArrowRight, ArrowLeft,
      Sparkles, Zap, Shield, Heart, MessageCircle, Moon, Sun, Cloud,
      Mic, Image as ImageIcon, Plus, Thermometer, Wind, Fingerprint, 
      Smile, Frown, Meh, Save, Trash2, Mail, Share2, Crown, Swords, Ghost,
      Flame, Anchor, Compass, Lock, Phone, AlertTriangle, SkipForward, Calendar, Clock
    } = window.lucideReact; 

    // --- CONFIGURATION API ---
    const MISTRAL_API_KEY = "TA_CLE_ICI"; // Remplacez si vous avez la cl√©, sinon laissez tel quel

    // --- MOTEUR IA ---
    const callBackend = async (systemPrompt, userPrompt, jsonMode = false) => {
      // 1. Mode Simulation (Pas de cl√©)
      if (MISTRAL_API_KEY === "TA_CLE_ICI") {
        await new Promise(r => setTimeout(r, 1500));
        return null; 
      }
      // 2. Mode R√©el (Appel API via backend s√©curis√© si configur√©, sinon direct pour test)
      try {
        // Tentative d'appel au fichier api/chat.js (si configur√© sur Vercel)
        const response = await fetch('/api/chat', { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ systemPrompt, userPrompt, jsonMode })
        });
        
        // Si le fichier api/chat.js n'existe pas (404), on tente l'appel direct (risqu√© mais marche pour test)
        if (response.status === 404) {
             console.warn("Backend non trouv√©, tentative appel direct (Test only)");
             const directResponse = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${MISTRAL_API_KEY}`
                },
                body: JSON.stringify({
                    model: "mistral-small-latest",
                    response_format: jsonMode ? { type: "json_object" } : { type: "text" },
                    messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }]
                })
            });
            const directData = await directResponse.json();
            return directData.choices[0].message.content;
        }

        if (!response.ok) throw new Error("Erreur serveur");
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error("Erreur IA:", error);
        return null;
      }
    };

    const LYA_AI = {
      analyzeHero: async (scores) => {
        const fallback = (() => {
            let archetype = "Guerrier";
            let advice = "Ta force est dans l'action.";
            if (scores.knowledge > scores.competence) { archetype = "Sage"; advice = "Connaissance de soi."; }
            else if (scores.belonging > scores.security) { archetype = "Gardien"; advice = "Lien aux autres."; }
            else if (scores.competence > scores.belonging) { archetype = "B√¢tisseur"; advice = "Capacit√© √† cr√©er."; }
            
            return {
                title: `${archetype} de Lumi√®re`,
                stats: scores,
                mission: `Ton score de comp√©tence est de ${Math.round((scores.competence/15)*100)}%. D√©fi : Fais une chose que tu repousses depuis 2 jours.`
            };
        })();
        
        const system = `Tu es Lya, psy TCC. Analyse les scores et renvoie un JSON { "title": "Nom Arch√©type", "mission": "Mission courte" }`;
        const user = `Scores: ${JSON.stringify(scores)}`;
        
        const res = await callBackend(system, user, true);
        try { return res ? JSON.parse(res) : fallback; } catch (e) { return fallback; }
      },
      
      generateOracle: async () => {
         const SAGES = ["Le Vieux Sage", "L'Esprit de la For√™t", "Le Ph√©nix", "Le Guerrier Pacifique"];
         const METAPHORS = [
           "La rivi√®re ne force pas son passage, elle coule.",
           "M√™me l'arbre le plus grand a commenc√© comme une graine.",
           "Les nuages passent, mais le ciel reste bleu.",
           "On ne peut pas voir son reflet dans l'eau qui bout."
         ];
         const ADVICES = [
           "Respire et accepte ce moment.",
           "Ta valeur ne d√©pend pas de ta r√©ussite.",
           "Fais un pas, m√™me petit.",
           "Sois doux avec toi-m√™me aujourd'hui."
         ];
         
         const fallback = { 
             title: SAGES[Math.floor(Math.random()*SAGES.length)], 
             text: `"${METAPHORS[Math.floor(Math.random()*METAPHORS.length)]} ${ADVICES[Math.floor(Math.random()*ADVICES.length)]}"` 
         };

         const system = `Tu es l'Oracle. Donne une m√©taphore courte et sage. JSON: { "title": "Nom", "text": "Message" }`;
         const res = await callBackend(system, "Oracle", true);
         try { return res ? JSON.parse(res) : fallback; } catch (e) { return fallback; }
      },
      
      synthesizeIdentity: async (answers) => {
          const res = await callBackend("Fais une synth√®se 'Cold Reading' bienveillante en 2 phrases.", JSON.stringify(answers), false);
          return res || "Tu as une personnalit√© riche et des go√ªts bien affirm√©s. Ta capacit√© √† savoir ce que tu aimes est une force. (Mode D√©mo)";
      },
      
      analyzeEcho: async (history) => {
          const fallback = { observation: "Tu as travers√© des √©motions vari√©es.", conseil: "N'oublie pas d'utiliser ta strat√©gie de gratitude." };
          const system = `Analyse cette session TCC. JSON: { "observation": "...", "conseil": "..." }`;
          const res = await callBackend(system, JSON.stringify(history), true);
          try { return res ? JSON.parse(res) : fallback; } catch (e) { return fallback; }
      }
    };

    /* --- DATA --- */
    const REALISTIC_SCENARIOS = [
      { id: 1, text: "Tu ouvres Insta et tu tombes sur une story : tous tes potes sont ensemble sans toi.", type: 'neg' },
      { id: 2, text: "Le prof rend les contr√¥les. Tu caches ta feuille car tu as honte de ta note.", type: 'neg' },
      { id: 3, text: "Tes parents te reprochent encore d'√™tre 'tout le temps sur ton t√©l√©phone'.", type: 'neg' },
      { id: 4, text: "Tu as envoy√© un message risqu√© √† ton crush. 'Vu', pas de r√©ponse depuis 2h.", type: 'neg' },
      { id: 5, text: "Tu te regardes dans le miroir avant de sortir. Rien ne va, tu te trouves horrible.", type: 'neg' },
      { id: 6, text: "On t'interroge √† l'oral. Ta gorge se serre, aucun son ne sort.", type: 'neg' },
      { id: 7, text: "Tu entends ton pr√©nom chuchot√© dans le couloir suivi d'un rire moqueur.", type: 'neg' },
      { id: 8, text: "Dimanche soir. Tu penses √† la semaine qui arrive et tu as une boule au ventre.", type: 'neg' },
      { id: 20, text: "Tu as r√©ussi un truc difficile du premier coup. Personne n'a vu, mais tu es fier(e).", type: 'pos' },
      { id: 21, text: "Tu √©coutes ta playlist √† fond dans ta chambre. Tu te sens invincible.", type: 'pos' },
      { id: 22, text: "Quelqu'un te fait un compliment sinc√®re sur ton style aujourd'hui.", type: 'pos' },
      { id: 23, text: "Tu as aid√© un pote qui n'allait pas bien. Il te remercie.", type: 'pos' },
      { id: 30, text: "Tu es seul(e) chez toi. Le silence est total.", type: 'neu' },
      { id: 31, text: "Tu marches dans la rue avec tes √©couteurs, tu as l'impression d'√™tre dans un clip.", type: 'neu' }
    ];

    const EMOTIONS = [
      { id: 'colere', emoji: 'üò°', label: 'Rage' }, { id: 'peur', emoji: 'üò∞', label: 'Stress' },
      { id: 'tristesse', emoji: 'üò¢', label: 'Tristesse' }, { id: 'honte', emoji: 'üò≥', label: 'Honte' },
      { id: 'vide', emoji: 'üò∂', label: 'Vide' }, { id: 'calme', emoji: 'üòå', label: 'Calme' },
      { id: 'joie', emoji: 'ü§©', label: 'Joie' }, { id: 'confiance', emoji: 'ü¶Å', label: 'Fiert√©' },
    ];

    const STRATEGIES = [
      { id: 'parler', icon: MessageCircle, label: "J'en parle" }, { id: 'musique', icon: Play, label: "Musique" },
      { id: 'isolement', icon: Moon, label: "Je m'isole" }, { id: 'sport', icon: Activity, label: "Je bouge" },
      { id: 'scroll', icon: Fingerprint, label: "√âcrans" }, { id: 'art', icon: Sparkles, label: "Cr√©ation" },
      { id: 'gratitude', icon: Heart, label: "Gratitude" }, { id: 'savourer', icon: Sun, label: "Je savoure" },
    ];

    const HERO_QUIZ = [
      { cat: 'competence', q: "Je finis ce que je commence." }, { cat: 'competence', q: "Je sais r√©soudre mes probl√®mes." }, { cat: 'competence', q: "J'ai des talents dont je suis fier(e)." }, { cat: 'competence', q: "Je r√©ussis aussi bien que les autres." }, { cat: 'competence', q: "Je me sens utile au quotidien." },
      { cat: 'knowledge', q: "Je sais dire ce que je ressens." }, { cat: 'knowledge', q: "Je connais mes points forts." }, { cat: 'knowledge', q: "J'ai mes propres opinions." },
      { cat: 'security', q: "Je me sens bien dans ma peau." }, { cat: 'security', q: "L'avenir ne me fait pas trop peur." }, { cat: 'security', q: "J'accepte mon corps tel qu'il est." },
      { cat: 'belonging', q: "Je me sens aim√©(e) par mes proches." }, { cat: 'belonging', q: "J'ai ma place dans un groupe." }, { cat: 'belonging', q: "Je peux compter sur quelqu'un." }
    ];

    const IDENTITY_SHORT_QUESTIONS = [
      { id: 'surnom', label: "Mon Surnom" }, { id: 'totem', label: "Animal Totem" }, { id: 'force', label: "Ma Force" }, { id: 'krypto', label: "Ma Faiblesse" },
      { id: 'hobby', label: "Passion n¬∞1" }, { id: 'song', label: "Chanson Hype" }, { id: 'color', label: "Couleur" }, { id: 'place', label: "Refuge" },
      { id: 'season', label: "Saison" }, { id: 'dream', label: "R√™ve fou" }, { id: 'fear', label: "Peur" }, { id: 'hero', label: "Idole" },
      { id: 'food', label: "Plat confort" }, { id: 'word', label: "Mot pr√©f√©r√©" }, { id: 'mood', label: "Vibe actuelle" }
    ];

    /* --- UI HELPERS --- */
    const GlassPanel = ({ children, className = '', onClick }) => (
      <div onClick={onClick} className={`backdrop-blur-xl bg-[#1e1b4b]/70 border border-white/10 shadow-2xl rounded-[32px] overflow-hidden ${className}`}>{children}</div>
    );
    const ActionButton = ({ onClick, children, variant = 'primary', className = '', disabled }) => {
      const s = { primary: "bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg shadow-indigo-500/30", secondary: "bg-white/5 text-white border border-white/10", accent: "bg-gradient-to-r from-emerald-500 to-teal-500 text-white", gold: "bg-gradient-to-r from-amber-400 to-orange-500 text-white", };
      return <button onClick={onClick} disabled={disabled} className={`px-6 py-4 rounded-2xl font-bold transition-all active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 ${styles[variant]} ${className}`}>{children}</button>;
    };
    const Tag = ({ text, type }) => {
        const colors = { neutral: 'bg-slate-700/50 text-slate-300', pos: 'bg-emerald-500/20 text-emerald-300', neg: 'bg-rose-500/20 text-rose-300' };
        return <span className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${colors[type || 'neutral']}`}>{text}</span>;
    };
    const NavIcon = ({ Icon, active, onClick }) => (
      <button onClick={onClick} className={`p-2 transition-colors ${active ? 'text-white' : 'text-slate-500 hover:text-slate-300'}`}><Icon size={24} /></button>
    );

    /* --- MODULES --- */
    const SOSModal = ({ onClose }) => (
        <div className="absolute inset-0 z-[100] bg-slate-900/95 backdrop-blur-xl flex items-center justify-center p-6 animate-fade-in"><div className="w-full max-w-sm bg-[#1e1b4b] border border-red-500/30 rounded-[32px] p-6 text-center shadow-[0_0_50px_rgba(220,38,38,0.3)]"><div className="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 animate-pulse"><AlertTriangle size={40}/></div><h2 className="text-3xl font-black text-white mb-2">Besoin d'aide ?</h2><div className="space-y-4"><a href="tel:3114" className="block w-full bg-red-600 text-white font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-3"><Phone size={24}/> 31 14 (√âcoute)</a><a href="tel:15" className="block w-full bg-white text-slate-900 font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-3"><Activity size={24}/> 15 (Urgence)</a></div><button onClick={onClose} className="mt-8 text-slate-500 font-bold text-sm uppercase tracking-widest">Retour</button></div></div>
    );

    const AuthScreen = ({ onLogin }) => {
        const [email, setEmail] = useState(''); const [pin, setPin] = useState('');
        return (
            <div className="h-full flex flex-col items-center justify-center p-8 animate-fade-in"><div className="w-24 h-24 rounded-full bg-gradient-to-tr from-violet-600 to-indigo-600 flex items-center justify-center shadow-[0_0_50px_rgba(139,92,246,0.5)] mb-8 border-4 border-[#0f0b1e]"><Fingerprint size={40} className="text-white"/></div><h1 className="text-3xl font-black text-white mb-2">TheraSpace</h1><p className="text-slate-400 mb-10">Ton refuge num√©rique.</p><div className="w-full space-y-4"><GlassPanel className="p-4 flex items-center gap-3"><Mail className="text-slate-500" size={20}/><input type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="bg-transparent text-white w-full focus:outline-none"/></GlassPanel><GlassPanel className="p-4 flex items-center gap-3"><Lock className="text-slate-500" size={20}/><input type="password" placeholder="Code (ex: 0000)" value={pin} onChange={e=>setPin(e.target.value)} className="bg-transparent text-white w-full focus:outline-none font-bold tracking-widest"/></GlassPanel><ActionButton onClick={() => onLogin({ name: email.split('@')[0] || 'Voyageur' })} disabled={!email || pin.length < 4} className="w-full mt-4">Entrer <ArrowRight/></ActionButton></div></div>
        );
    };

    const Dashboard = ({ onNavigate, user }) => {
        const [showSOS, setShowSOS] = useState(false);
        return (
            <div className="h-full overflow-y-auto scrollbar-hide p-6 pt-10 pb-32 space-y-8 animate-fade-in relative">
                {showSOS && <SOSModal onClose={() => setShowSOS(false)} />}
                <header className="flex justify-between items-center"><div><h1 className="text-3xl font-black text-white tracking-tight mb-1">Salut {user.name}</h1><p className="text-indigo-300 text-sm">Espace S√©curis√©</p></div><div className="flex gap-3"><button onClick={()=>setShowSOS(true)} className="w-12 h-12 rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-500 animate-pulse"><AlertTriangle size={24}/></button><button onClick={()=>onNavigate('profile')} className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-400"><User size={24}/></button></div></header>
                <div onClick={()=>onNavigate('echo')} className="relative group cursor-pointer active:scale-95 transition-transform"><div className="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-[32px] blur opacity-60"/><GlassPanel className="relative p-8 flex items-center justify-between"><div><div className="flex items-center gap-2 mb-2"><span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"/><span className="text-xs font-bold text-indigo-200 uppercase tracking-wider">Lya Active</span></div><h3 className="text-3xl font-black text-white mb-2">√âCHO</h3><p className="text-slate-300 text-sm">Exploration guid√©e</p></div><div className="w-16 h-16 rounded-full bg-white/10 flex items-center justify-center text-white"><Play size={24}/></div></GlassPanel></div>
                <div className="grid grid-cols-2 gap-4"><GlassPanel className="p-6 active:scale-95 transition-transform" onClick={()=>onNavigate('journal')}><Book className="text-emerald-400 mb-4" size={28}/><h4 className="font-bold text-white">Journal</h4></GlassPanel><GlassPanel className="p-6 active:scale-95 transition-transform" onClick={()=>onNavigate('hero')}><Shield className="text-amber-400 mb-4" size={28}/><h4 className="font-bold text-white">H√©ros</h4></GlassPanel></div>
            </div>
        );
    };

    const EchoGame = ({ onExit, onFinish }) => {
        const [cards, setCards] = useState(REALISTIC_SCENARIOS.sort(()=>0.5-Math.random()).slice(0,10));
        const [index, setIndex] = useState(0);
        const [step, setStep] = useState('scenario');
        const [history, setHistory] = useState([]);
        const [current, setCurrent] = useState({vecu:false, emotions:[], strategies:[]});
        const card = cards[index];
        const handleNext = () => { const newHistory = [...history, {card, ...current}]; if (index < cards.length - 1) { setHistory(newHistory); setIndex(i=>i+1); setStep('scenario'); setCurrent({vecu:false, emotions:[], strategies:[]}); } else onFinish(newHistory); };
        const toggle = (list, item) => list.includes(item) ? list.filter(i=>i!==item) : [...list, item];
        return (
            <div className="h-full flex flex-col p-6 pt-10 relative">
                <div className="flex justify-between items-center mb-6"><button onClick={onExit}><X className="tex
